<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ä¸ªäººç®€å†åŠ¨æ€åŠ è½½</title>
  <style>
    body{margin:20px;background:#f5f5f5;font-family:Arial,sans-serif;display:flex;justify-content:center}
    .card{width:800px;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:20px}
    h1,h2{margin:0 0 10px}
    .loading{color:#999}
    .error{color:red}
    button{margin:10px 0;padding:6px 12px}
    ul{padding-left:20px}
  </style>
</head>
<body>
  <div class="card">
    <h1>ä¸ªäººç®€å†</h1>
    <button id="refreshBtn">åˆ·æ–°</button>

    <h2>åŸºæœ¬ä¿¡æ¯</h2>
    <div id="base" class="loading">æ­£åœ¨åŠ è½½ä¸­...</div>

    <h2>æŠ€èƒ½åˆ—è¡¨</h2>
    <div id="skill" class="loading">æ­£åœ¨åŠ è½½ä¸­...</div>

    <h2>è‡ªæˆ‘ä»‹ç»</h2>
    <div id="intro" class="loading">æ­£åœ¨åŠ è½½ä¸­...</div>

    <h2>æ•™è‚²èƒŒæ™¯</h2>
    <div id="edu" class="loading">æ­£åœ¨åŠ è½½ä¸­...</div>

    <h2>é¡¹ç›®ç»å†ï¼ˆå®æ—¶æ¨é€ï¼‰</h2>
    <ul id="project" class="loading">æ­£åœ¨åŠ è½½ä¸­...</ul>
  </div>

  <script>
    const URL = 'https://teaching.ncuos.com';
    let basicInfoId = '';          // å…¨å±€ä¿å­˜ id
    let ws = null;                 // WebSocket å®ä¾‹

    // ===== ç»Ÿä¸€é”™è¯¯å¤„ç† =====
    function showError(container, msg) {
      document.getElementById(container).innerHTML = `<p class="error">${msg}</p>`;
    }

    // ===== åŠ è½½çŠ¶æ€ =====
    function showLoading(container) {
      document.getElementById(container).innerHTML = '<p class="loading">æ­£åœ¨åŠ è½½ä¸­...</p>';
    }

    // ===== 1. åŸºæœ¬ä¿¡æ¯ =====
    async function loadBase() {
      showLoading('base');
      try {
        const res = await fetch(`${URL}/baseInfo`);
        if (!res.ok) throw new Error('åŸºç¡€ä¿¡æ¯è¯·æ±‚å¤±è´¥');
        const data = await res.json();
        basicInfoId = data.id;   // ä¿å­˜ id
        document.getElementById('base').innerHTML = `
          <p>å§“åï¼š${data.name}</p>
          <p>IDï¼š${data.id}</p>
          <p>ç”µè¯ï¼š${data.phone}</p>
          <p>é‚®ç®±ï¼š${data.email}</p>
          <p>GitHubï¼š${data.githubLink}</p>
        `;
        // æˆåŠŸåå¹¶è¡ŒåŠ è½½åç»­æ•°æ®
        loadSkill();
        loadIntro();
        loadEdu();
        loadProjectWS(); // WebSocket
      } catch (e) {
        showError('base', e.message);
      }
    }

    // ===== 2. æŠ€èƒ½åˆ—è¡¨ï¼ˆå« 418 å½©è›‹ï¼‰ =====
    async function loadSkill() {
      showLoading('skill');
      const tryFetch = async () => {
        const res = await fetch(`${URL}/skillList`);
        if (res.status === 418) {
          document.getElementById('skill').innerHTML = '<p>è·å–æŠ€èƒ½å¤±è´¥ï¼Œæˆ‘å¯èƒ½æ˜¯ä¸€ä¸ªèŒ¶å£¶ ğŸ«–</p>';
          return;
        }
        if (!res.ok) throw new Error('æŠ€èƒ½åˆ—è¡¨è¯·æ±‚å¤±è´¥');
        const skills = await res.json();
        const trueSkills = Object.keys(skills).filter(k => skills[k]);
        const html = trueSkills.length ? `<ul>${trueSkills.map(s => `<li>${s}</li>`).join('')}</ul>` : '<p>æš‚æ— æŠ€èƒ½</p>';
        document.getElementById('skill').innerHTML = html;
      };
      try { await tryFetch(); } catch (e) { showError('skill', e.message); }
    }

    // ===== 3. è‡ªæˆ‘ä»‹ç» =====
    async function loadIntro() {
      showLoading('intro');
      try {
        const res = await fetch(`${URL}/selfIntroduction?id=${basicInfoId}`);
        if (!res.ok) throw new Error('è‡ªæˆ‘ä»‹ç»è¯·æ±‚å¤±è´¥');
        const data = await res.json();
        document.getElementById('intro').innerHTML = `<p>${data.selfIntroduction}</p>`;
      } catch (e) {
        showError('intro', e.message);
      }
    }

    // ===== 4. æ•™è‚²èƒŒæ™¯ï¼ˆPOST ä½“ï¼‰ =====
    async function loadEdu() {
      showLoading('edu');
      try {
        const res = await fetch(`${URL}/eduExperience`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: basicInfoId })
        });
        if (!res.ok) throw new Error('æ•™è‚²èƒŒæ™¯è¯·æ±‚å¤±è´¥');
        const data = await res.json();
        document.getElementById('edu').innerHTML = `<p>${data.eduBackground}</p>`;
      } catch (e) {
        showError('edu', e.message);
      }
    }

    // ===== 5. WebSocket å®æ—¶é¡¹ç›®ç»å† =====
    function loadProjectWS() {
      document.getElementById('project').innerHTML = '<p class="loading">ç­‰å¾…å®æ—¶æ¨é€...</p>';
      if (ws) ws.close(); // å…ˆå…³æ—§è¿æ¥
      ws = new WebSocket(`${URL}/projectExperience/basicWS`);
      ws.onmessage = e => {
        try {
          const proj = JSON.parse(e.data);
          const li = document.createElement('li');
          li.innerHTML = `<h3>${proj.name || proj.title}</h3><p>${proj.description}</p>`;
          document.getElementById('project').appendChild(li);
          // ç¬¬ä¸€æ¬¡æ”¶åˆ°åå»æ‰â€œç­‰å¾…â€æç¤º
          const loading = document.querySelector('#project .loading');
          if (loading) loading.remove();
        } catch (err) {
          console.error('é¡¹ç›®æ¨é€è§£æå¤±è´¥:', err);
        }
      };
      ws.onerror = () => showError('project', 'WebSocket è¿æ¥å¤±è´¥');
    }

    // ===== åˆ·æ–°æŒ‰é’® =====
    document.getElementById('refreshBtn').addEventListener('click', () => {
      loadBase(); // é‡æ–°æ‹‰å–å…¨éƒ¨æ•°æ®
    });

    // ===== é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¯åŠ¨ =====
    window.onload = () => loadBase();
  </script>
</body>
</html>